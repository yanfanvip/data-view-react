{"version":3,"file":"index.js","sources":["../../src/components/scrollRankingBoard/index.js"],"sourcesContent":["import React, { useEffect, useRef, useState, useMemo, forwardRef } from 'react'\n\nimport PropTypes from 'prop-types'\n\nimport classnames from 'classnames'\n\nimport { deepMerge } from '@jiaminghi/charts/lib/util/index'\n\nimport { deepClone } from '@jiaminghi/c-render/lib/plugin/util'\n\nimport useAutoResize from '../../use/autoResize'\nimport { co } from '../../util'\n\nimport './style.less'\n\nconst defaultConfig = {\n  /**\n   * @description Board data\n   * @type {Array<Object>}\n   * @default data = []\n   */\n  data: [],\n  /**\n   * @description Row num\n   * @type {Number}\n   * @default rowNum = 5\n   */\n  rowNum: 5,\n  /**\n   * @description Scroll wait time\n   * @type {Number}\n   * @default waitTime = 2000\n   */\n  waitTime: 2000,\n  /**\n   * @description Carousel type\n   * @type {String}\n   * @default carousel = 'single'\n   * @example carousel = 'single' | 'page'\n   */\n  carousel: 'single',\n  /**\n   * @description Value unit\n   * @type {String}\n   * @default unit = ''\n   * @example unit = 'ton'\n   */\n  unit: '',\n  /**\n   * @description Auto sort by value\n   * @type {Boolean}\n   * @default sort = true\n   */\n  sort: true,\n  /**\n   * @description Value formatter\n   * @type {Function}\n   * @default valueFormatter = null\n   */\n  valueFormatter: null\n}\n\nfunction calcRows({ data, rowNum, sort }) {\n  sort && data.sort(({ value: a }, { value: b }) => {\n    if (a > b) return -1\n    if (a < b) return 1\n    if (a === b) return 0\n  })\n\n  const value = data.map(({ value }) => value)\n\n  const min = Math.min(...value) || 0\n\n  // 最小值的绝对值\n  const minAbs = Math.abs(min)\n\n  const max = Math.max(...value) || 0\n\n  // 最大值的绝对值\n  const maxAbs = Math.abs(max)\n\n  // 总数为最大值与最小值的绝对值相加\n  const total = maxAbs + minAbs\n\n  data = data.map((row, i) => ({\n    ...row,\n    ranking: i + 1,\n    percent: total && ((row.value + minAbs) / total * 100)\n  }))\n\n  const rowLength = data.length\n\n  if (rowLength > rowNum && rowLength < 2 * rowNum) {\n    data = [...data, ...data]\n  }\n\n  data = data.map((d, i) => ({ ...d, scroll: i }))\n\n  return data\n}\n\nconst ScrollRankingBoard = forwardRef(({ config = {}, className, style }, ref) => {\n  const { width, height, domRef } = useAutoResize(ref)\n\n  const [state, setState] = useState({\n    mergedConfig: null,\n\n    rows: [],\n\n    heights: []\n  })\n\n  const { mergedConfig, rows, heights } = state\n\n  const stateRef = useRef({\n    ...state,\n    rowsData: [],\n    avgHeight: 0,\n    animationIndex: 0\n  })\n\n  const heightRef = useRef(height)\n\n  Object.assign(stateRef.current, state)\n\n  function onResize(onresize = false) {\n    if (!mergedConfig) return\n\n    const heights = calcHeights(mergedConfig, onresize)\n\n    if (heights !== undefined) {\n      Object.assign(stateRef.current, { heights })\n      setState(state => ({ ...state, heights }))\n    }\n  }\n\n  function calcData() {\n    const mergedConfig = deepMerge(deepClone(defaultConfig, true), config || {})\n\n    const rows = calcRows(mergedConfig)\n\n    const heights = calcHeights(mergedConfig)\n\n    const data = { mergedConfig, rows }\n\n    heights !== undefined && Object.assign(data, { heights })\n\n    Object.assign(stateRef.current, data, { rowsData: rows, animationIndex: 0 })\n\n    setState(state => ({ ...state, ...data }))\n  }\n\n  function calcHeights({ rowNum, data }, onresize = false) {\n    const avgHeight = height / rowNum\n\n    Object.assign(stateRef.current, { avgHeight })\n\n    if (!onresize) {\n      return new Array(data.length).fill(avgHeight)\n    }\n  }\n\n  function * animation(start = false) {\n    let {\n      avgHeight,\n      animationIndex,\n      mergedConfig: { waitTime, carousel, rowNum },\n      rowsData\n    } = stateRef.current\n\n    const rowLength = rowsData.length\n\n    if (start) yield new Promise(resolve => setTimeout(resolve, waitTime))\n\n    const animationNum = carousel === 'single' ? 1 : rowNum\n\n    let rows = rowsData.slice(animationIndex)\n    rows.push(...rowsData.slice(0, animationIndex))\n    rows = rows.slice(0, rowNum + 1)\n\n    const heights = new Array(rowLength).fill(avgHeight)\n    setState(state => ({ ...state, rows, heights }))\n\n    yield new Promise(resolve => setTimeout(resolve, 300))\n\n    animationIndex += animationNum\n\n    const back = animationIndex - rowLength\n    if (back >= 0) animationIndex = back\n\n    const newHeights = [...heights]\n    newHeights.splice(0, animationNum, ...new Array(animationNum).fill(0))\n\n    Object.assign(stateRef.current, { animationIndex })\n    setState(state => ({ ...state, heights: newHeights }))\n  }\n\n  useEffect(() => {\n    calcData()\n\n    let start = true\n\n    function * loop() {\n      while (true) {\n        yield * animation(start)\n\n        start = false\n\n        const { waitTime } = stateRef.current.mergedConfig\n\n        yield new Promise(resolve => setTimeout(resolve, waitTime - 300))\n      }\n    }\n\n    const {\n      mergedConfig: { rowNum },\n      rows: rowsData\n    } = stateRef.current\n\n    const rowLength = rowsData.length\n\n    if (rowNum >= rowLength) return\n\n    return co(loop).end\n  }, [config, domRef.current])\n\n  useEffect(() => {\n    if (heightRef.current === 0 && height !== 0) {\n      onResize()\n\n      heightRef.current = height\n    } else {\n      onResize(true)\n    }\n  }, [width, height, domRef.current])\n\n  const classNames = useMemo(\n    () => classnames('dv-scroll-ranking-board', className),\n    [className]\n  )\n\n  return (\n    <div className={classNames} style={style} ref={domRef}>\n      {rows.map((item, i) => (\n        <div\n          className='row-item'\n          key={item.toString() + item.scroll}\n          style={{ height: `${heights[i]}px` }}\n        >\n          <div className='ranking-info'>\n            <div className='rank'>No.{item.ranking}</div>\n            <div className='info-name' dangerouslySetInnerHTML={{ __html: item.name }} />\n            <div className='ranking-value'>\n              {mergedConfig.valueFormatter ? mergedConfig.valueFormatter(item) : item.value + mergedConfig.unit}\n            </div>\n          </div>\n\n          <div className='ranking-column'>\n            <div\n              className='inside-column'\n              style={{ width: `${item.percent}%` }}\n            >\n              <div className='shine' />\n            </div>\n          </div>\n        </div>\n      ))}\n    </div>\n  )\n})\n\nScrollRankingBoard.propTypes = {\n  config: PropTypes.object,\n  className: PropTypes.string,\n  style: PropTypes.object\n}\n\nexport default ScrollRankingBoard\n"],"names":["defaultConfig","data","rowNum","waitTime","carousel","unit","sort","valueFormatter","calcRows","a","value","b","map","min","Math","minAbs","abs","max","maxAbs","total","row","i","ranking","percent","rowLength","length","d","scroll","ScrollRankingBoard","forwardRef","ref","config","className","style","animation","useAutoResize","width","height","domRef","useState","mergedConfig","rows","heights","state","setState","stateRef","useRef","rowsData","avgHeight","animationIndex","heightRef","Object","assign","current","onResize","onresize","calcHeights","undefined","calcData","deepMerge","deepClone","Array","fill","start","Promise","setTimeout","resolve","animationNum","slice","push","back","newHeights","splice","useEffect","loop","co","end","classNames","useMemo","classnames","item","toString","__html","name","propTypes","PropTypes","object","string"],"mappings":"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"}